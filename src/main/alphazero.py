import os
import sys
from subprocess import Popen


def decide_if_switch_model():
	with open(winners_file, "r") as file:
		for last_line in file:
			pass
		# If outsider model won, outsider becomes champion and we can go back to mcts_trial
		if last_line[0] == "O":
			return True
		# If the champion won we need to train the model again without executing mcts_trial
		else:
			return False
			
def init():
	print("********************************************************************************************")
	print("****************************************INITIALIZING****************************************")
	print("********************************************************************************************")
	Popen("ant clean", shell=True).wait()
	print("********************************************************************************************")
	print("*****************************************COMPILING******************************************")
	print("********************************************************************************************")
	Popen("ant build", shell=True).wait()
	
def conclude():
	print("********************************************************************************************")
	print("*****************************************CREATING AGENT*************************************")
	print("********************************************************************************************")
	Popen("ant create_agent", shell=True).wait()
	print("********************************************************************************************")
	print("*****************************************AGENT READY****************************************")
	print("********************************************************************************************")
			
if __name__ == '__main__':
	winners_file="./models/winners.txt"
	alphazero_iteration=0
	trial=True

	init()	

	while(alphazero_iteration < int(sys.argv[1])):
		print("============================================================================================")
		print("==================================ITERATION ALPHAZERO", alphazero_iteration, "====================================")
		print("============================================================================================")
		if trial:
			print("********************************************************************************************")
			print("****************************************MCTS TRIALS*****************************************")
			print("********************************************************************************************")
			Popen("ant mcts_trials & ant mcts_trials & ant mcts_trials & wait", shell=True).wait()
			print("********************************************************************************************")
			print("***************************************MERGING DATASETS*************************************")
			print("********************************************************************************************")
			Popen("python3 src_python/merge_datasets.py", shell=True).wait()
		print("********************************************************************************************")
		print("***************************************TRAINING MODEL***************************************")
		print("********************************************************************************************")
		Popen("python3 src_python/train_model.py", shell=True).wait()
		# If it's the first step we won't go for a dojo since there is only one model ready
		if alphazero_iteration >= 1:	
			print("********************************************************************************************")
			print("*****************************************MCTS DOJO******************************************")
			print("********************************************************************************************")
			Popen("ant mcts_dojo", shell=True).wait()
			trial = decide_if_switch_model()
			if trial:
				Popen("python3 src_python/switch_model.py", shell=True).wait()
		alphazero_iteration += 1
		
	conclude()
	
